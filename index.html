<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Trading Dashboard</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&display=swap" rel="stylesheet">
  <script src="https://unpkg.com/pocketbase@0.10.0/dist/pocketbase.umd.js"></script>
  <style>
    :root {
      --primary-color: #3498db;
      --secondary-color: #2ecc71;
      --background-light: #f4f6f7;
      --text-color: #2c3e50;
      --card-background: #ffffff;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Inter', sans-serif;
      display: flex;
      height: 100vh;
      background-color: var(--background-light);
      color: var(--text-color);
      line-height: 1.6;
    }

    .left-panel, .right-panel {
      width: 50%;
      padding: 20px;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
    }

    .left-panel {
      background-color: #ffffff;
      border-right: 1px solid #e0e0e0;
    }

    .panel-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 20px;
    }

    .panel-title {
      font-size: 1.5rem;
      font-weight: 600;
      color: var(--text-color);
    }

    .connection-container {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
    }

    .input-group {
      display: flex;
      flex-direction: column;
      gap: 5px;
      flex-grow: 1;
    }

    input, button {
      padding: 10px;
      border-radius: 6px;
      border: 1px solid #e0e0e0;
      font-size: 0.9rem;
    }

    .btn {
      background-color: var(--primary-color);
      color: white;
      border: none;
      cursor: pointer;
      transition: background-color 0.3s ease;
    }

    .btn:hover {
      opacity: 0.9;
    }

    .btn-secondary {
      background-color: var(--secondary-color);
    }

    .logs-container {
      background-color: var(--card-background);
      border-radius: 8px;
      padding: 15px;
      max-height: 300px;
      overflow-y: auto;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }

    .log-entry {
      background-color: #f9f9f9;
      margin-bottom: 5px;
      padding: 5px;
      border-radius: 4px;
      font-size: 0.8rem;
    }

    .position-card {
      background-color: var(--card-background);
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 10px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
      transition: transform 0.3s ease;
    }

    .position-card:hover {
      transform: translateY(-5px);
    }

    .profit-positive {
      color: var(--secondary-color);
    }

    .profit-negative {
      color: #e74c3c;
    }
  </style>
</head>
<body>
  <div class="left-panel">
    <div class="panel-header">
      <h1 class="panel-title">MetaAPI Trading Dashboard</h1>
    </div>

    <div class="connection-container">
      <div class="input-group">
        <label>MetaAPI Token</label>
        <input type="text" id="metaapi-token" placeholder="Enter MetaAPI Token">
      </div>
      <button id="connect-metaapi" class="btn">Connect MetaAPI</button>
    </div>

    <div class="logs-container" id="info"></div>
    
    <div>
      <h2 class="panel-title">Real-Time Positions</h2>
      <div id="positions-container"></div>
    </div>
  </div>

  <div class="right-panel">
    <div class="panel-header">
      <h1 class="panel-title">PocketBase Connection</h1>
    </div>

    <div class="connection-container">
      <button id="connect-pocketbase" class="btn btn-secondary">Connect PocketBase</button>
    </div>

    <div class="logs-container" id="pocketbase-logs"></div>
  </div>

  <script src="https://unpkg.com/metaapi.cloud-sdk"></script>
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      // PocketBase Setup
      const pb = new PocketBase('https://databases-pocketbase.rmtdmw.shanmuganathan.dev');
      const pocketbaseLogs = document.getElementById('pocketbase-logs');
      const connectPocketbaseButton = document.getElementById('connect-pocketbase');

      function pbLog(message) {
        const el = document.createElement('div');
        el.className = 'log-entry';
        el.textContent = message;
        pocketbaseLogs.appendChild(el);
        console.log(message);
      }

      async function authenticateAndSubscribe() {
        try {
          const authData = await pb.collection('users').authWithPassword('vsnshanmuga@gmail.com', 'lUzBWt5mB6PNC7t');
          pbLog('User Authenticated: ' + JSON.stringify(authData));

          pb.collection('longShort_duplicate').subscribe('*', function (e) {
            pbLog(`Action: ${e.action}, Record: ${JSON.stringify(e.record)}`);
          });

        } catch (error) {
          pbLog('Authentication failed: ' + error.message);
        }
      }

      connectPocketbaseButton.addEventListener('click', authenticateAndSubscribe);

      // MetaAPI Setup
      const infoElement = document.getElementById('info');
      const positionsContainer = document.getElementById('positions-container');
      const connectMetaAPIButton = document.getElementById('connect-metaapi');
      const metaAPITokenInput = document.getElementById('metaapi-token');

      function log(message) {
        const el = document.createElement('div');
        el.className = 'log-entry';
        el.textContent = message;
        infoElement.appendChild(el);
        console.log(message);
      }

      function displayPositions(positions) {
        positionsContainer.innerHTML = '';
        if (Object.keys(positions).length === 0) {
          positionsContainer.innerHTML = '<p>No open positions</p>';
          return;
        }

        for (const id in positions) {
          const position = positions[id];
          const positionCard = document.createElement('div');
          positionCard.className = 'position-card';
          
          const profit = parseFloat(position.profit);
          const profitClass = profit >= 0 ? 'profit-positive' : 'profit-negative';

          positionCard.innerHTML = `
            <h3>${position.symbol}</h3>
            <p>Type: ${position.type}</p>
            <p>Volume: ${position.volume}</p>
            <p>Open Price: ${position.openPrice}</p>
            <p>Current Price: ${position.currentPrice || 'N/A'}</p>
            <p>Profit: <span class="${profitClass}">${profit.toFixed(2)} ${position.profit}</span></p>
            <p>Time: ${new Date(position.time).toLocaleString()}</p>
          `;

          positionsContainer.appendChild(positionCard);
        }
      }

      async function testMetaApiSynchronization(token) {
        try {
          const api = new MetaApi.default(token);
          const accounts = await api.metatraderAccountApi.getAccounts();
          
          if (accounts.length === 0) {
            log('No MetaTrader accounts found');
            return;
          }

          const account = accounts[0];
          log(`Connected to account: ${account.id}`);

          const connection = account.getStreamingConnection();
          await connection.connect();
          await connection.waitSynchronized();

          const terminalState = connection.terminalState;
          displayPositions(terminalState.positions);

          log('Real-time tracking activated');

        } catch (error) {
          log('Connection error: ' + error.message);
        }
      }

      connectMetaAPIButton.addEventListener('click', () => {
        const token = metaAPITokenInput.value.trim();
        if (token) {
          testMetaApiSynchronization(token);
        } else {
          log('Please enter a valid MetaAPI token');
        }
      });
    });
  </script>
</body>
</html>
