<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Advanced Trading Dashboard</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&display=swap" rel="stylesheet">
    <link rel="icon" type="image/png" href="favicon.png">
    <style>
        :root {
            --bg-primary: #f4f7f6;
            --bg-secondary: #ffffff;
            --text-primary: #2c3e50;
            --text-secondary: #7f8c8d;
            --accent-color: #3498db;
            --accent-color-hover: #2980b9;
            --border-color: #e0e6e9;
            --success-color: #2ecc71;
            --danger-color: #e74c3c;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            scrollbar-width: thin;
            scrollbar-color: var(--accent-color) var(--bg-primary);
        }

        *::-webkit-scrollbar {
            width: 8px;
        }

        *::-webkit-scrollbar-track {
            background: var(--bg-primary);
        }

        *::-webkit-scrollbar-thumb {
            background-color: var(--accent-color);
            border-radius: 20px;
        }

        html, body {
            height: 100%;
            overflow: hidden;
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-primary);
            color: var(--text-primary);
        }

        .dashboard {
            display: flex;
            height: 100vh;
        }

        .panel {
            width: 50%;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 20px;
            background-color: var(--bg-secondary);
            border-right: 1px solid var(--border-color);
        }

        .connection-section {
            display: flex;
            flex-direction: column;
            gap: 15px;
            background-color: var(--bg-secondary);
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .input-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .input-group label {
            font-weight: 600;
            color: var(--text-secondary);
        }

        .input-group input {
            padding: 12px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s ease;
        }

        .btn {
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .btn-primary {
            background-color: var(--accent-color);
            color: white;
        }

        .btn-success {
            background-color: var(--success-color);
            color: white;
        }

        .btn-danger {
            background-color: var(--danger-color);
            color: white;
        }

        .btn:hover {
            opacity: 0.9;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .positions-container {
            flex-grow: 1;
            overflow-y: auto;
            border-radius: 12px;
            border: 1px solid var(--border-color);
        }

        .positions-table {
            width: 100%;
            border-collapse: collapse;
        }

        .positions-table th {
            position: sticky;
            top: 0;
            background-color: var(--bg-primary);
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }

        .positions-table td {
            padding: 12px;
            border-bottom: 1px solid var(--border-color);
        }

        .log-container {
            flex-grow: 1;
            overflow-y: auto;
            background-color: #f4f4f4;
            padding: 15px;
            border-radius: 8px;
        }

        .log-entry {
            margin-bottom: 8px;
            padding: 8px;
            background-color: #ffffff;
            border-radius: 4px;
            font-size: 0.9em;
        }

        .trade-controls {
            display: flex;
            gap: 10px;
            align-items: center;
        }
    </style>
</head>
<body>
    <div class="dashboard">
        <div class="panel">
            <div class="connection-section">
                <h2>MetaAPI Connection</h2>
                <div class="input-group">
                    <label>Token</label>
                    <input type="text" id="metaapi-token" placeholder="Enter MetaAPI Token">
                </div>
                <div class="input-group">
                    <label>Account ID</label>
                    <input type="text" id="metaapi-account-id" placeholder="Enter Account ID">
                </div>
                <button id="connect-metaapi" class="btn btn-primary">Connect MetaAPI</button>
            </div>

            <div class="connection-section">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <h2>Trading Controls</h2>
                    <div class="trade-controls">
                        <input type="text" id="trade-symbol" value="BTCUSDm" placeholder="Symbol">
                        <input type="number" id="trade-volume" value="0.01" step="0.01" placeholder="Volume">
                        <button id="buy-btn" class="btn btn-success">Buy</button>
                        <button id="sell-btn" class="btn btn-danger">Sell</button>
                    </div>
                </div>
            </div>

            <div class="connection-section positions-container">
                <h2>Open Positions</h2>
                <table class="positions-table" id="positions-table">
                    <thead>
                        <tr>
                            <th>Symbol</th>
                            <th>Type</th>
                            <th>Volume</th>
                            <th>Open Price</th>
                            <th>Current Price</th>
                            <th>Profit</th>
                            <th>Time</th>
                        </tr>
                    </thead>
                    <tbody id="positions-tbody">
                        <tr><td colspan="7">No open positions</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <div class="panel">
            <div class="connection-section">
                <h2>PocketBase Connection</h2>
                <button id="connect-pocketbase" class="btn btn-primary">Connect PocketBase</button>
            </div>

            <div class="connection-section log-container" id="pocketbase-logs">
                <h2>PocketBase Logs</h2>
            </div>

            <div class="connection-section log-container" id="metaapi-logs">
                <h2>MetaAPI Logs</h2>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/pocketbase@0.10.0/dist/pocketbase.umd.js"></script>
    <script src="https://unpkg.com/metaapi.cloud-sdk"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // Configuration
            const PB_URL = 'https://databases-pocketbase.rmtdmw.shanmuganathan.dev';
            const PB_EMAIL = 'vsnshanmuga@gmail.com';
            const PB_PASSWORD = 'lUzBWt5mB6PNC7t';
            const DEFAULT_SYMBOL = 'BTCUSDm';
            const DEFAULT_VOLUME = 0.01;

            // DOM Elements
            const elements = {
                metaApiToken: document.getElementById('metaapi-token'),
                metaApiAccountId: document.getElementById('metaapi-account-id'),
                connectMetaApi: document.getElementById('connect-metaapi'),
                connectPocketBase: document.getElementById('connect-pocketbase'),
                buyBtn: document.getElementById('buy-btn'),
                sellBtn: document.getElementById('sell-btn'),
                tradeSymbol: document.getElementById('trade-symbol'),
                tradeVolume: document.getElementById('trade-volume'),
                positionsTbody: document.getElementById('positions-tbody'),
                pocketbaseLogs: document.getElementById('pocketbase-logs'),
                metaApiLogs: document.getElementById('metaapi-logs')
            };

            // State
            let currentConnection = null;
            const pb = new PocketBase(PB_URL);

            // Logging Utilities
            const createLogEntry = (container, message, type = 'info') => {
                const entry = document.createElement('div');
                entry.classList.add('log-entry', `log-${type}`);
                entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
                container.prepend(entry);
            };

            // Trade Execution
            const executeTrade = async (type) => {
                if (!currentConnection) {
                    createLogEntry(elements.metaApiLogs, 'MetaAPI not connected', 'error');
                    return;
                }

                try {
                    const symbol = elements.tradeSymbol.value.trim();
                    const volume = parseFloat(elements.tradeVolume.value);

                    if (!symbol || isNaN(volume) || volume <= 0) {
                        createLogEntry(elements.metaApiLogs, 'Invalid trade parameters', 'error');
                        return;
                    }

                    const tradeMethod = type === 'buy' 
                        ? currentConnection.createMarketBuyOrder 
                        : currentConnection.createMarketSellOrder;

                    const result = await tradeMethod.call(
                        currentConnection, 
                        symbol, 
                        volume, 
                        { 
                            comment: `${type.toUpperCase()} Trade`, 
                            clientId: `TRADE_${symbol}_${Date.now()}` 
                        }
                    );

                    createLogEntry(
                        elements.metaApiLogs, 
                        `${type.toUpperCase()} Order Executed: ${JSON.stringify(result)}`, 
                        'success'
                    );
                } catch (error) {
                    createLogEntry(
                        elements.metaApiLogs, 
                        `Trade Error: ${error.message}`, 
                        'error'
                    );
                }
            };

            // MetaAPI Connection
            const connectMetaApi = async () => {
                const token = elements.metaApiToken.value.trim();
                const accountId = elements.metaApiAccountId.value.trim();

                if (!token || !accountId) {
                    createLogEntry(elements.metaApiLogs, 'Invalid MetaAPI credentials', 'error');
                    return;
                }

                try {
                    const api = new MetaApi.default(token);
                    const account = await api.metatraderAccountApi.getAccount(accountId);
                    
                    currentConnection = account.getStreamingConnection();
                    await currentConnection.connect();
                    await currentConnection.waitSynchronized();

                    createLogEntry(elements.metaApiLogs, 'MetaAPI Connected Successfully', 'success');
                    
                    // Enable trade buttons
                    elements.buyBtn.disabled = false;
                    elements.sellBtn.disabled = false;
                } catch (error) {
                    createLogEntry(elements.metaApiLogs, `Connection Failed: ${error.message}`, 'error');
                }
            };

            // PocketBase Connection
            const connectPocketBase = async () => {
                try {
                    await pb.collection('users').authWithPassword(PB_EMAIL, PB_PASSWORD);
                    
                    createLogEntry(elements.pocketbaseLogs, 'PocketBase Authenticated', 'success');
                    
                    pb.collection('longShort_duplicate').subscribe('*', (e) => {
                        createLogEntry(
                            elements.pocketbaseLogs, 
                            `Event: ${e.action}, Record: ${JSON.stringify(e.record)}`
                        );

                        // Automatic trading logic
                        if (e.action === 'create' && currentConnection) {
                            executeTrade('buy');
                        }
                    });
                } catch (error) {
                    createLogEntry(elements.pocketbaseLogs, `Auth Failed: ${error.message}`, 'error');
                }
            };

            // Event Listeners
            elements.connectMetaApi.addEventListener('click', connectMetaApi);
            elements.connectPocketBase.addEventListener('click', connectPocketBase);
            elements.buyBtn.addEventListener('click', () => executeTrade('buy'));
            elements.sellBtn.addEventListener('click', () => executeTrade('sell'));

            // Initial Setup
            elements.buyBtn.disabled = true;
            elements.sellBtn.disabled = true;
            elements.tradeSymbol.value = DEFAULT_SYMBOL;
            elements.tradeVolume.value = DEFAULT_VOLUME;
        });
    </script>
</body>
</html>
